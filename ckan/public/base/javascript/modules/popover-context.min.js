window.popover_context={dict:{user:{},dataset:{},group:{},accessreq:{}},render:{user:{},dataset:{},group:{},accessreq:{}}};this.ckan.module("popover-context",function(e,t){return{options:{id:null,loading:false,error:false,authed:false,throbber:'<img src="{SITE_ROOT}/base/images/loading-spinner.gif">',i18n:{loading:t("Loading...")}},initialize:function(){if(this.options.id!=true&&this.options.id!=null){e.proxyAll(this,/_on/);if(e(".account").hasClass("authed")){this.options.authed=e(".account").data("me")}this.el.popover({animation:false,content:this.options.throbber.replace("{SITE_ROOT}",ckan.SITE_ROOT)+this.i18n("loading"),placement:"bottom"});this.el.on("mouseover",this._onMouseOver);e(document).on("mouseup",this._onDocumentMouseUp);this.sandbox.subscribe("follow-follow-"+this.options.id,this._onHandleFollow);this.sandbox.subscribe("follow-unfollow-"+this.options.id,this._onHandleFollow)}},_onDocumentMouseUp:function(e){var t=this.el.data("popover");if(typeof t.$tip!="undefined"){if(t.$tip.has(e.target).length===0){this.el.popover("hide")}}},loadingHelper:function(e){this.options.loading=e;var t=this.el.data("popover");if(typeof t.$tip!="undefined"){if(e){t.$tip.addClass("popover-context-loading")}else{t.$tip.removeClass("popover-context-loading")}}},_onMouseOver:function(){e('[data-module="popover-context"]').popover("hide");this.el.popover("show");this.getData()},getData:function(){if(!this.options.loading){this.loadingHelper(true);var e=this.options.id;var t=this.options.type;if(typeof window.popover_context.dict[t][e]=="undefined"){var n=this.sandbox.client;var r=t+"_show";if(t=="dataset"){r="package_show"}n.call("GET",r,"?id="+e,this._onHandleData,this._onHandleError)}else{this._onHandleData(window.popover_context.dict[t][e])}}},_onHandleError:function(t){e('[data-module="popover-context"][data-module-type="'+this.options.type+'"][data-module-id="'+this.options.id+'"]').popover("destroy")},_onHandleData:function(e){if(e.success){var t=this.options.id;var n=this.options.type;var r=this.sandbox.client;window.popover_context.dict[n][t]=e;if(typeof window.popover_context.render[n][t]=="undefined"){var i=this.sanitiseParams(e.result);r.getTemplate("popover_context_"+n+".html",i,this._onRenderPopover)}else{this._onRenderPopover(window.popover_context.render[n][t])}}},sanitiseParams:function(e){var t=this.options.type;var n={};if(t=="user"){n.id=e.id;n.name=e.name;n.about=e.about;n.display_name=e.display_name;n.num_followers=e.num_followers;n.number_administered_packages=e.number_administered_packages;n.number_of_edits=e.number_of_edits;n.is_me=e.id==this.options.authed}else if(t=="dataset"){n.id=e.id;n.title=e.title;n.name=e.name;n.notes=e.notes;if(e.resources){n.num_resources=e.resources.length}n.num_tags=e.tags.length}else if(t=="group"){n.id=e.id;n.title=e.title;n.name=e.name;n.description=e.description;n.num_datasets=e.packages.length;n.num_followers=e.num_followers}else if(t=="accessreq"){n.following=e.ret=="Yes";n.title=e.title;n.no_owner=e.no_owner;n.id=e.id}return n},_onRenderPopover:function(t){var n=this.options.id;var r=this.options.type;var i=window.popover_context.dict[r][n].result;var s=this.el.data("popover");if(typeof s.$tip!="undefined"){var o=s.$tip;var u=r=="user"?i.display_name:i.title;e(".popover-title",o).html('<a href="javascript:;" class="popover-close">Ã—</a>'+u);e(".popover-content",o).html(t);e(".popover-close",o).on("click",this._onClickPopoverClose);var a=this.getFollowButton();if(a){ckan.module.initializeElement(a[0])}this.loadingHelper(false)}window.popover_context.render[r][n]=t},_onClickPopoverClose:function(){this.el.popover("hide")},getFollowButton:function(){var t=this.el.data("popover");if(typeof t.$tip!="undefined"){var n=e('[data-module="follow"]',t.$tip);if(n.length>0){return n}}return false},_onHandleFollow:function(){delete window.popover_context.render[this.options.type][this.options.id]}}})